# Attack Vulnerability Service

## Visión General

El Attack Vulnerability Service es un componente especializado del sistema AISS que proporciona análisis de vulnerabilidades basado en el framework MITRE ATT&CK. Este servicio se integra con el terminal-gateway-service para detectar y notificar vulnerabilidades potenciales en sistemas remotos durante sesiones SSH, mejorando la seguridad operativa.

## Características Principales

- **Análisis basado en MITRE ATT&CK**: Utiliza la base de conocimiento de MITRE ATT&CK para identificar técnicas y tácticas aplicables a software y sistemas operativos detectados
- **Integración con Terminal**: Se conecta con el servicio de terminal para analizar automáticamente los sistemas a los que se accede
- **Detección de Software**: Identifica sistemas operativos y paquetes de software instalados
- **Alertas de Seguridad**: Notifica sobre vulnerabilidades de alta severidad en tiempo real
- **Caché Persistente**: Mantiene una caché local de datos ATT&CK para mejorar el rendimiento

## Arquitectura

```
┌────────────────┐      ┌────────────────┐
│                │      │                │
│  Terminal      │──────►  Attack        │
│  Gateway       │      │  Vulnerability │
│  Service       │◄─────┤  Service       │
│                │      │                │
└────────────────┘      └───────┬────────┘
                                │
                                ▼
                        ┌────────────────┐
                        │                │
                        │  MITRE ATT&CK  │
                        │  Data (API/    │
                        │  Local Cache)  │
                        │                │
                        └────────────────┘
```

## Configuración

El Attack Vulnerability Service se configura a través de variables de entorno:

```
# Configuración básica
PORT=8094
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=INFO

# Configuración de seguridad
AUTH_ENABLED=true
API_KEY={SECRET_KEY}

# Configuración ATT&CK
ATTACK_CACHE_DIR=/app/cache
ATTACK_CACHE_TTL_HOURS=24

# Configuración de análisis
HIGH_SEVERITY_THRESHOLD=0.8
MEDIUM_SEVERITY_THRESHOLD=0.5
MAX_VULNERABILITIES_PER_REPORT=50
```

## Integración con Terminal

La integración con el Terminal Gateway Service ocurre en varios puntos:

1. **Detección inicial**: Cuando un usuario se conecta a un sistema remoto, se realiza una detección de OS y software
2. **Análisis en segundo plano**: La información detectada se envía al servicio de vulnerabilidades para análisis
3. **Alertas en tiempo real**: Las vulnerabilidades críticas identificadas se notifican al usuario a través del terminal
4. **Resumen de vulnerabilidades**: Se proporciona un resumen de todas las vulnerabilidades identificadas

## API

El servicio expone los siguientes endpoints REST:

- **GET /health**: Comprueba el estado del servicio
- **POST /api/v1/check**: Analiza vulnerabilidades en un sistema (requiere API key)
- **GET /api/v1/sessions/{session_id}/vulnerabilities**: Obtiene vulnerabilidades de una sesión específica
- **GET /api/v1/techniques/{technique_id}**: Obtiene detalles sobre una técnica MITRE ATT&CK específica

## Flujo de Detección

1. El usuario inicia una sesión SSH a través del terminal-gateway-service
2. El sistema detecta el sistema operativo y software instalado (mediante comandos como `uname`, `dpkg`, `rpm`, etc.)
3. Los datos de software detectados se envían al attack-vulnerability-service
4. El servicio consulta su base local de MITRE ATT&CK para identificar posibles vulnerabilidades
5. Las vulnerabilidades se clasifican por severidad y se envían de vuelta al terminal
6. El usuario recibe alertas sobre vulnerabilidades críticas en tiempo real

## Tipos de Vulnerabilidades

El servicio identifica diferentes tipos de vulnerabilidades:

- **Vulnerabilidades de OS**: Basadas en el sistema operativo y su versión
- **Vulnerabilidades de Software**: Basadas en paquetes específicos y sus versiones
- **Problemas de Configuración**: Detectadas mediante el análisis de la configuración del sistema

## Ejemplo de Respuesta

```json
{
  "session_id": "f7e92a3b-8c74-42e9-9f3d-8d89c8f9b245",
  "vulnerabilities": [
    {
      "id": "vuln-001",
      "title": "T1190 - Exploit Public-Facing Application",
      "severity": "high",
      "affected_software": "nginx",
      "affected_version": "1.18.0",
      "mitre_technique_id": "T1190",
      "mitigation": "Actualizar a la versión más reciente y aplicar parches de seguridad"
    }
  ],
  "summary": {
    "high_risk": 1,
    "medium_risk": 3,
    "low_risk": 5,
    "total": 9
  },
  "scan_timestamp": "2025-04-08T14:30:45Z"
}
```

## Limitaciones

- El servicio depende de la capacidad de ejecutar comandos en el sistema remoto
- La precisión de la detección depende de los privilegios disponibles en el sistema remoto
- No se realizan pruebas activas de vulnerabilidades, solo análisis basado en versiones conocidas

## Seguridad

- Utiliza API keys para proteger el acceso
- No almacena información sensible sobre los sistemas analizados más allá de la sesión
- Los análisis se realizan localmente, sin enviar datos a servicios externos

## Mantenimiento

- La caché de datos ATT&CK se actualiza automáticamente según el intervalo configurado
- Se recomienda actualizar la imagen del servicio periódicamente para obtener las últimas definiciones de vulnerabilidades
- Los logs del servicio proporcionan información detallada sobre el análisis realizado