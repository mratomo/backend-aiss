# Docker Compose configuration for AISS

#################################################
# Definición de servicios para el sistema AISS  #

#################################################

services:
  #-----------------------------------------
  # FASE 1: Servicios de bases de datos
  #-----------------------------------------
  mongodb:
    image: mongo:6.0.5
    container_name: aiss-mongodb
    volumes:
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/data/mongodb:/data/db
      # Configuración específica del contenedor
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/config/mongodb:/docker-entrypoint-initdb.d
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=password
      # Configuración adicional para mejor rendimiento y seguridad
      - MONGO_INITDB_DATABASE=mcp_knowledge_system
      - MONGODB_ENABLE_JOURNAL=true
      - MONGODB_OPLOG_SIZE=128
      - MONGODB_BIND_IP=0.0.0.0
    ports:
      - "27017:27017"
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping')"
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - aiss-network
      
  weaviate:
    image: semitechnologies/weaviate:1.24.3
    container_name: aiss-weaviate
    volumes:
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/data/weaviate:/var/lib/weaviate
    environment:
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - DEFAULT_VECTORIZER_MODULE=none
      - CLUSTER_HOSTNAME=node1
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - ENABLE_MODULES=backup
      - AUTOSCHEMA_ENABLED=true
    ports:
      - "6333:8080"
    healthcheck:
      test: wget -q --spider http://localhost:8080/v1/.well-known/ready || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - aiss-network

  neo4j:
    image: neo4j:5.9.0
    container_name: aiss-neo4j
    volumes:
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/data/neo4j/data:/data
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/data/neo4j/logs:/logs
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/data/neo4j/plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/supersecret
      - NEO4J_PLUGINS=["graph-data-science"]
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    ports:
      - "7474:7474"
      - "7687:7687"
    healthcheck:
      test: wget -O /dev/null -q http://localhost:7474 || exit 1
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - aiss-network

  minio:
    image: minio/minio:RELEASE.2023-07-21T21-12-44Z
    container_name: aiss-minio
    volumes:
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/data/minio:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
      - MINIO_HEALTHCHECK_SERVER=true
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: curl -f http://127.0.0.1:9000/minio/health/ready || exit 1
      interval: 30s
      timeout: 20s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - aiss-network

  # Servicios de configuración de bases de datos con manejo robusto basado en pruebas
  mongodb-setup:
    image: mongo:6.0.5
    container_name: aiss-mongodb-setup
    volumes:
      - ./db/mongodb/mongodb.js:/scripts/mongodb.js
    # Entrypoint modificado para manejar errores y reintentos
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "echo 'Esperando a que MongoDB esté disponible...' &&
      mongosh --host mongodb --port 27017 -u admin -p password --authenticationDatabase admin --quiet --eval 'db.adminCommand(\"ping\")' &&
      echo 'Ejecutando script de inicialización de MongoDB...' &&
      mongosh --host mongodb --port 27017 -u admin -p password --authenticationDatabase admin /scripts/mongodb.js &&
      echo 'Inicialización de MongoDB completada'"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - aiss-network

  weaviate-setup:
    image: curlimages/curl:8.2.1
    container_name: aiss-weaviate-setup
    entrypoint: ["/bin/sh", "-c"]
    # Script integrado para crear clases en Weaviate sin depender del archivo externo
    command: >
      "echo 'Esperando a que Weaviate esté disponible...' &&
      until curl -s -f http://weaviate:8080/v1/.well-known/ready; do
        echo 'Esperando a que Weaviate esté listo...';
        sleep 5;
      done &&
      echo 'Weaviate está disponible. Creando clases...' &&
      curl -X POST 'http://weaviate:8080/v1/schema' -H 'Content-Type: application/json' -d '{
        \"class\": \"GeneralKnowledge\",
        \"vectorizer\": \"none\",
        \"vectorIndexConfig\": {
          \"distance\": \"cosine\"
        },
        \"properties\": [
          {
            \"name\": \"doc_id\",
            \"dataType\": [\"string\"],
            \"description\": \"ID del documento\",
            \"indexFilterable\": true,
            \"indexSearchable\": true
          },
          {
            \"name\": \"owner_id\",
            \"dataType\": [\"string\"],
            \"description\": \"ID del propietario\",
            \"indexFilterable\": true,
            \"indexSearchable\": true
          },
          {
            \"name\": \"area_id\",
            \"dataType\": [\"string\"],
            \"description\": \"ID del área\",
            \"indexFilterable\": true,
            \"indexSearchable\": true
          },
          {
            \"name\": \"text\",
            \"dataType\": [\"text\"],
            \"description\": \"Texto del embedding\",
            \"indexFilterable\": true,
            \"indexSearchable\": true,
            \"tokenization\": \"field\"
          },
          {
            \"name\": \"meta_info\",
            \"dataType\": [\"string\"],
            \"description\": \"Metadatos adicionales como JSON string\",
            \"indexFilterable\": false,
            \"indexSearchable\": false
          }
        ]
      }' &&
      echo 'Creando clase PersonalKnowledge...' &&
      curl -X POST 'http://weaviate:8080/v1/schema' -H 'Content-Type: application/json' -d '{
        \"class\": \"PersonalKnowledge\",
        \"vectorizer\": \"none\",
        \"vectorIndexConfig\": {
          \"distance\": \"cosine\"
        },
        \"properties\": [
          {
            \"name\": \"doc_id\",
            \"dataType\": [\"string\"],
            \"description\": \"ID del documento\",
            \"indexFilterable\": true,
            \"indexSearchable\": true
          },
          {
            \"name\": \"owner_id\",
            \"dataType\": [\"string\"],
            \"description\": \"ID del propietario\",
            \"indexFilterable\": true,
            \"indexSearchable\": true
          },
          {
            \"name\": \"area_id\",
            \"dataType\": [\"string\"],
            \"description\": \"ID del área\",
            \"indexFilterable\": true,
            \"indexSearchable\": true
          },
          {
            \"name\": \"text\",
            \"dataType\": [\"text\"],
            \"description\": \"Texto del embedding\",
            \"indexFilterable\": true,
            \"indexSearchable\": true,
            \"tokenization\": \"field\"
          },
          {
            \"name\": \"meta_info\",
            \"dataType\": [\"string\"],
            \"description\": \"Metadatos adicionales como JSON string\",
            \"indexFilterable\": false,
            \"indexSearchable\": false
          }
        ]
      }' &&
      echo 'Verificando esquema creado...' &&
      curl -s http://weaviate:8080/v1/schema &&
      echo 'Inicialización de Weaviate completada'"
    depends_on:
      weaviate:
        condition: service_healthy
    networks:
      - aiss-network

  minio-setup:
    image: minio/mc:latest
    container_name: aiss-minio-setup
    entrypoint: ["/bin/sh", "-c"]
    # Script integrado para configurar MinIO correctamente
    command: >
      "mc alias set myminio http://minio:9000 minioadmin minioadmin &&
      echo 'Creando buckets de MinIO...' &&
      mc mb --ignore-existing myminio/documents &&
      mc mb --ignore-existing myminio/uploads &&
      mc mb --ignore-existing myminio/temp &&
      mc mb --ignore-existing myminio/personal-documents &&
      mc mb --ignore-existing myminio/shared-documents &&
      echo 'Configurando permisos...' &&
      mc anonymous set download myminio/documents &&
      mc anonymous set upload myminio/uploads &&
      mc anonymous set public myminio/temp &&
      mc anonymous set download myminio/personal-documents &&
      mc anonymous set download myminio/shared-documents &&
      echo 'Verificando configuración de buckets:' &&
      mc ls myminio &&
      echo 'Inicialización de MinIO completada'"
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - aiss-network
  
  neo4j-setup:
    image: neo4j:5.9.0
    container_name: aiss-neo4j-setup
    # Configuración de Neo4j con manejo robusto de inicialización
    entrypoint: ["/bin/bash", "-c"]
    command: >
      "echo 'Esperando a que Neo4j esté disponible...' &&
      until cypher-shell -a bolt://neo4j:7687 -u neo4j -p supersecret 'RETURN 1;' > /dev/null 2>&1; do
        echo 'Esperando a que Neo4j esté listo...';
        sleep 5;
      done &&
      echo 'Neo4j disponible. Creando constraints e índices...' &&
      cypher-shell -a bolt://neo4j:7687 -u neo4j -p supersecret '
      CREATE CONSTRAINT unique_database_id IF NOT EXISTS
      FOR (d:Database)
      REQUIRE d.connection_id IS UNIQUE;
      
      CREATE CONSTRAINT unique_table_id IF NOT EXISTS
      FOR (t:Table)
      REQUIRE t.table_id IS UNIQUE;
      
      CREATE CONSTRAINT unique_column_id IF NOT EXISTS
      FOR (c:Column)
      REQUIRE c.column_id IS UNIQUE;
      
      CREATE INDEX database_name_index IF NOT EXISTS
      FOR (d:Database)
      ON (d.name);
      
      CREATE INDEX table_name_index IF NOT EXISTS
      FOR (t:Table)
      ON (t.name);
      
      CREATE INDEX column_name_index IF NOT EXISTS
      FOR (c:Column)
      ON (c.name);
      
      CREATE INDEX table_schema_index IF NOT EXISTS
      FOR (t:Table)
      ON (t.schema);
      ' &&
      echo 'Verificando instalación del plugin Graph Data Science...' &&
      cypher-shell -a bolt://neo4j:7687 -u neo4j -p supersecret 'CALL gds.list() YIELD name RETURN count(name) AS procedureCount' &&
      echo 'Inicialización de Neo4j completada'"
    environment:
      - NEO4J_HOST=neo4j
      - NEO4J_PORT=7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=supersecret
    depends_on:
      neo4j:
        condition: service_healthy
    networks:
      - aiss-network

  #-----------------------------------------
  # FASE 2: Servicios core
  #-----------------------------------------
  user-service:
    build: 
      context: ./core-services/user-service
    image: aiss-user-service
    container_name: aiss-user-service
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/aiss?authSource=admin
      - JWT_SECRET=${JWT_SECRET:-supersecretkey}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-supersecretrefreshkey}
      - AUTH_SECRET=${JWT_SECRET:-supersecretkey}
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8081:8081"
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8081/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - aiss-network

  document-service:
    build:
      context: ./core-services/document-service
    image: aiss-document-service
    container_name: aiss-document-service
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/aiss?authSource=admin
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_USE_SSL=false
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8082:8082"
    depends_on:
      mongodb:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8082/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - aiss-network

  api-gateway:
    build:
      context: ./api-gateway
    image: aiss-api-gateway
    container_name: aiss-api-gateway
    environment:
      - USER_SERVICE_URL=http://user-service:8081
      - DOCUMENT_SERVICE_URL=http://document-service:8082
      - DB_CONNECTION_SERVICE_URL=http://db-connection-service:8086
      - SCHEMA_DISCOVERY_SERVICE_URL=http://schema-discovery-service:8087
      - CONTEXT_SERVICE_URL=http://context-service:8083
      - EMBEDDING_SERVICE_URL=http://embedding-service:8084
      - RAG_AGENT_URL=http://rag-agent:8085
      - TERMINAL_GATEWAY_URL=http://terminal-gateway-service:8090
      - JWT_SECRET=${JWT_SECRET:-supersecretkey}
      - AUTH_SECRET=${JWT_SECRET:-supersecretkey}
      - PORT=8088
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    # El API Gateway debe ser accesible tanto desde el frontend como desde el host para pruebas
    ports:
      - "8088:8088"
    depends_on:
      user-service:
        condition: service_healthy
      document-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8088/api/health || exit 1
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - aiss-network

  #-----------------------------------------
  # FASE 3: Servicios MCP
  #-----------------------------------------
  context-service:
    build:
      context: ./mcp-services/context-service
    image: aiss-context-service
    container_name: aiss-context-service
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/aiss?authSource=admin
      - EMBEDDING_SERVICE_URL=http://embedding-service:8084
      - MCP_API_URL=http://context-service:8083/api/v1/mcp
      - LOG_LEVEL=info
    ports:
      - "8083:8083"
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: curl -f http://localhost:8083/health || exit 1
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aiss-network

  embedding-service:
    build:
      context: ./mcp-services/embedding-service
    image: aiss-embedding-service
    container_name: aiss-embedding-service
    # Agregar acceso a la GPU para Nomic
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/aiss?authSource=admin
      # Configuración para base de datos vectorial
      - VECTOR_DB=weaviate
      - WEAVIATE_URL=http://weaviate:8080
      - WEAVIATE_CLASS_GENERAL=GeneralKnowledge
      - WEAVIATE_CLASS_PERSONAL=PersonalKnowledge
      # Configuración de modelo y servicios
      - MCP_SERVICE_URL=http://context-service:8083
      - MCP_SERVICE_TIMEOUT=30.0
      - ALLOW_DEGRADED_MODE=true
      - USE_HTTPX=true
      # Configuración de modelo embedding
      - GENERAL_EMBEDDING_MODEL=nomic-ai/nomic-embed-text-v1.5
      - USE_GPU=true
      - USE_8BIT=true
      - USE_FP16=true
      - FALLBACK_TO_CPU=true
      # Configuración de límites y control de errores
      - MAX_DOCUMENT_SIZE_MB=20
      - MAX_TEXTS_PER_BATCH=50
      - CORS_ALLOWED_ORIGINS=["http://localhost:3000","http://localhost","http://localhost:80"]
      - LOG_LEVEL=info
    ports:
      - "8084:8084"
    depends_on:
      mongodb:
        condition: service_healthy
      weaviate:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8084/health || exit 1
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - aiss-network

  rag-agent:
    build:
      context: ./rag-agent
    image: aiss-rag-agent
    container_name: aiss-rag-agent
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/aiss?authSource=admin
      # Configuración de servicios dependientes
      - EMBEDDING_SERVICE_URL=http://embedding-service:8084
      - CONTEXT_SERVICE_URL=http://context-service:8083
      - DOCUMENT_SERVICE_URL=http://document-service:8082
      - DB_CONNECTION_SERVICE_URL=http://db-connection-service:8086
      - SCHEMA_DISCOVERY_SERVICE_URL=http://schema-discovery-service:8087
      # Configuración de proveedores LLM
      - OLLAMA_API_BASE=${OLLAMA_BASE_URL:-http://ollama:11434}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      # Configuración de Neo4j para GraphRAG
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=supersecret
      # Configuración de comportamiento y límites
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
      - PORT=8085
      # Configuración avanzada de LLM
      - OLLAMA_USE_GPU=true
      - OLLAMA_IS_REMOTE=${OLLAMA_IS_REMOTE:-false}
      - DEFAULT_SYSTEM_PROMPT="Eres un asistente IA especializado en bases de datos y seguridad. Proporciona respuestas claras y precisas."
      - MAX_CONTEXT_LENGTH=4000
    ports:
      - "8085:8085"
    depends_on:
      mongodb:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      weaviate:
        condition: service_healthy
      context-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8085/health || exit 1
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - aiss-network

  #-----------------------------------------
  # FASE 4: Servicios DB
  #-----------------------------------------
  db-connection-service:
    build:
      context: ./db-services/db-connection-service
    image: aiss-db-connection-service
    container_name: aiss-db-connection-service
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/aiss?authSource=admin
      - SCHEMA_DISCOVERY_URL=http://schema-discovery-service:8087
      - EMBEDDING_SERVICE_URL=http://embedding-service:8084
      - MCP_SERVICE_URL=http://context-service:8083
      - DB_ENCRYPTION_KEY=${DB_ENCRYPTION_KEY:-supersecretencryptionkey}
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8086:8086"
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8086/health || exit 1
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - aiss-network

  schema-discovery-service:
    build:
      context: ./db-services/schema-discovery-service
    image: aiss-schema-discovery-service
    container_name: aiss-schema-discovery-service
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/aiss?authSource=admin
      - DB_CONNECTION_SERVICE_URL=http://db-connection-service:8086
      - EMBEDDING_SERVICE_URL=http://embedding-service:8084
      - MCP_SERVICE_URL=http://context-service:8083
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=supersecret
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8087:8087"
    depends_on:
      db-connection-service:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8087/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aiss-network

  attack-vulnerability-service:
    build:
      context: ./attack-vulnerability-service
    image: aiss-attack-vulnerability-service
    container_name: aiss-attack-vulnerability-service
    environment:
      - LLM_PROVIDER_URL=http://rag-agent:8085/api/v1/llm
      - MCP_SERVICE_URL=http://context-service:8083
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8092:8400"
    restart: unless-stopped
    depends_on:
      context-service:
        condition: service_started
    healthcheck:
      test: wget -qO- http://localhost:8400/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aiss-network

  #-----------------------------------------
  # FASE 5: Servicios Terminal
  #-----------------------------------------
  ollama:
    image: ollama/ollama:0.1.27
    container_name: aiss-ollama
    # Esta instancia local es para validación de consultas, necesita GPU para un mejor rendimiento
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    volumes:
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/data/ollama:/root/.ollama
    # Exponemos el puerto al host para el entorno de desarrollo
    ports:
      - "11434:11434"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:11434/api/tags || exit 1
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - aiss-network

  terminal-session-service:
    build:
      context: ./backend-aiss/terminal-services/terminal-session-service
    image: aiss-terminal-session-service
    container_name: aiss-terminal-session-service
    environment:
      - MONGODB_URI=mongodb://admin:password@mongodb:27017/aiss?authSource=admin
      - MCP_SERVICE_URL=http://context-service:8083
      - JWT_SECRET=${JWT_SECRET:-supersecretkey}
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8091:8091"
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8091/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - aiss-network

  terminal-gateway-service:
    build:
      context: ./backend-aiss/terminal-services/terminal-gateway-service
    image: aiss-terminal-gateway-service
    container_name: aiss-terminal-gateway-service
    volumes:
      - ${VOLUMES_PATH:-/home/prods/ssd/aissdata}/data/terminal-ssh-keys:/keys
    environment:
      - SESSION_SERVICE_URL=http://terminal-session-service:8091
      - VULNERABILITY_SERVICE_URL=http://attack-vulnerability-service:8092
      - CONTEXT_AGGREGATOR_URL=http://terminal-context-aggregator:8093
      - MCP_SERVICE_URL=http://context-service:8083
      - RAG_AGENT_URL=http://rag-agent:8085
      - JWT_SECRET=${JWT_SECRET:-supersecretkey}
      - SSH_KEYGEN_PATH=/usr/bin/ssh-keygen
      - SSH_KEY_DIR=/keys
      - SERVER_PORT=8090
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8090:8090"
    depends_on:
      terminal-session-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8090/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - aiss-network

  terminal-context-aggregator:
    build:
      context: ./backend-aiss/terminal-services/terminal-context-aggregator
    image: aiss-terminal-context-aggregator
    container_name: aiss-terminal-context-aggregator
    environment:
      - EMBEDDING_SERVICE_URL=http://embedding-service:8084
      - MCP_SERVICE_URL=http://context-service:8083
      - SUGGESTION_SERVICE_URL=http://terminal-suggestion-service:8094
      - JWT_SECRET=${JWT_SECRET:-supersecretkey}
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8093:8093"
    depends_on:
      context-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8093/health || exit 1
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aiss-network

  terminal-suggestion-service:
    build:
      context: ./backend-aiss/terminal-services/terminal-suggestion-service
    image: aiss-terminal-suggestion-service
    container_name: aiss-terminal-suggestion-service
    environment:
      - CONTEXT_AGGREGATOR_URL=http://terminal-context-aggregator:8093
      - MCP_SERVICE_URL=http://context-service:8083
      - LLM_SERVICE_URL=http://rag-agent:8085/api/v1/llm
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - JWT_SECRET=${JWT_SECRET:-supersecretkey}
      - CORS_ALLOWED_ORIGINS='["http://localhost:3000","http://localhost","http://localhost:80"]'
      - LOG_LEVEL=info
    ports:
      - "8094:8094"
    depends_on:
      terminal-context-aggregator:
        condition: service_healthy
      rag-agent:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: wget -qO- http://localhost:8094/health || exit 1
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aiss-network



# Red definida para todos los servicios
networks:
  aiss-network:
    driver: bridge